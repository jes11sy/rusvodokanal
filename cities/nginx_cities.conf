# Основной домен - показывает Саратов
server {
    server_name rusvodokanal.ru www.rusvodokanal.ru;
    
    root /var/www/rusvodokanal/cities/sar;
    index index.html;

    location = /index.html {
        return 301 /;
    }

    location ~ ^/(.+)\.html$ {
        return 301 /$1;
    }

    location / {
        try_files $uri $uri/ $uri.html =404;
    }

    error_page 404 /404.html;
    location = /404.html { internal; }

    location = /robots.txt {
        try_files /robots.txt =404;
        add_header Content-Type text/plain;
    }

    location = /sitemap.xml {
        try_files /sitemap.xml =404;
        add_header Content-Type application/xml;
    }

    location ~* \.(?:css|js|jpg|jpeg|png|gif|svg|webp|ico|woff2?)$ {
        expires 7d;
        add_header Cache-Control "public";
    }

    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/rusvodokanal.ru/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/rusvodokanal.ru/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

# Все поддомены городов
server {
    server_name ~^(?<city>sar|eng|oms|pnz|tol|uly|yar)\.rusvodokanal\.ru$;
    
    root /var/www/rusvodokanal/cities/$city;
    index index.html;

    location = /index.html {
        return 301 /;
    }

    location ~ ^/(.+)\.html$ {
        return 301 /$1;
    }

    location / {
        try_files $uri $uri/ $uri.html =404;
    }

    error_page 404 /404.html;
    location = /404.html { internal; }

    location = /robots.txt {
        try_files /robots.txt =404;
        add_header Content-Type text/plain;
    }

    location = /sitemap.xml {
        try_files /sitemap.xml =404;
        add_header Content-Type application/xml;
    }

    location ~* \.(?:css|js|jpg|jpeg|png|gif|svg|webp|ico|woff2?)$ {
        expires 7d;
        add_header Cache-Control "public";
    }

    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/rusvodokanal.ru/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/rusvodokanal.ru/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

# HTTP -> HTTPS
server {
    listen 80;
    server_name rusvodokanal.ru www.rusvodokanal.ru sar.rusvodokanal.ru eng.rusvodokanal.ru oms.rusvodokanal.ru pnz.rusvodokanal.ru tol.rusvodokanal.ru uly.rusvodokanal.ru yar.rusvodokanal.ru;
    return 301 https://$host$request_uri;
}
